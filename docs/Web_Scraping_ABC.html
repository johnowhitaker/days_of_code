---

title: Web Scraping ABC


keywords: fastai
sidebar: home_sidebar

summary: "Pulling Irish music for future experiments"
description: "Pulling Irish music for future experiments"
nb_path: "notebooks/14_Web_Scraping_ABC.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: notebooks/14_Web_Scraping_ABC.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Getting-Tune-URLs-with-BeautifulSoup">Getting Tune URLs with BeautifulSoup<a class="anchor-link" href="#Getting-Tune-URLs-with-BeautifulSoup"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://thesession.org/tunes/search?type=&amp;mode=Dmajor&amp;q=&amp;page=1&#39;</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="c1"># We would put thus in a try/catch block if we were being careful</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span> <span class="c1"># BeautifulSoup kindly parses the html for us</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For each page of results there is a list of ten songs. Each one is a list item (<code>li</code> in html) that starts with the following: <code># &lt;li class="manifest-item"&gt;</code>. We can use BeautifulSoup's findAll method to get all of these list items:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">list_items</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;manifest-item&quot;</span><span class="p">})</span>
<span class="n">urls</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">list_items</span><span class="p">:</span>
    <span class="n">link</span> <span class="o">=</span> <span class="n">li</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1"># Get the link to the tune</span>
    <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">))</span> <span class="c1"># Store it for later </span>

<span class="nb">print</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span> <span class="c1"># A list of URLs for us to scrape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[&#39;/tunes/27&#39;, &#39;/tunes/55&#39;, &#39;/tunes/182&#39;, &#39;/tunes/64&#39;, &#39;/tunes/9&#39;, &#39;/tunes/116&#39;, &#39;/tunes/73&#39;, &#39;/tunes/19&#39;, &#39;/tunes/49&#39;, &#39;/tunes/5&#39;]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Extracting-the-tune-from-the-tune-page">Extracting the tune from the tune page<a class="anchor-link" href="#Extracting-the-tune-from-the-tune-page"> </a></h3><p>There are often multiple 'arrangements'. Each get their own 'notes' div on the tune page - we use <code>find</code> instead of <code>findAll</code> to only get the first one:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tune_page</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://thesession.org&#39;</span><span class="o">+</span><span class="n">urls</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">tune_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">tune_page</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;html5lib&#39;</span><span class="p">)</span>
<span class="n">tune_content</span> <span class="o">=</span> <span class="n">tune_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;notes&quot;</span><span class="p">})</span>
<span class="n">tune_content</span><span class="o">.</span><span class="n">text</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;\nX: 1\nT: Drowsy Maggie\nR: reel\n\nM: 4/4\nL: 1/8\nK: Edor\n|:E2BE dEBE|E2BE AFDF|E2BE dEBE|BABc dAFD:|\nd2fd c2ec|defg afge|d2fd c2ec|BABc dAFA|\nd2fd c2ec|defg afge|afge fdec|BABc dAFD|\n\n&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I found it easiest at this stage to just parse the text above myself, using a function to pull out the tune title, info and notes:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="parse_tune" class="doc_header"><code>parse_tune</code><a href="https://github.com/johnowhitaker/days_of_code/tree/master/days_of_code/abc.py#L6" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>parse_tune</code>(<strong><code>tune_content</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">parse_tune</span><span class="p">(</span><span class="n">tune_content</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;Title&#39;: &#39;Drowsy Maggie&#39;,
 &#39;Type&#39;: &#39;reel&#39;,
 &#39;Meter&#39;: &#39;4/4&#39;,
 &#39;Length&#39;: &#39;1/8&#39;,
 &#39;Key&#39;: &#39;Edor&#39;,
 &#39;Notes&#39;: &#39;|:E2BE dEBE|E2BE AFDF|E2BE dEBE|BABc dAFD:|d2fd c2ec|defg afge|d2fd c2ec|BABc dAFA|d2fd c2ec|defg afge|afge fdec|BABc dAFD|&#39;}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Scraping-in-parallel">Scraping in parallel<a class="anchor-link" href="#Scraping-in-parallel"> </a></h3><p>I'm impatient, so I use some parallel processing with <code>ThreadPoolExecutor</code> to fetch up to ten tunes at once. There's a thread lock to stop concurrent writes to a csv file which I've set up <a href="/days_of_code/Web_Scraping_ABC.html#get_tune"><code>get_tune</code></a> to store the tunes in.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">csv_writer_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_tune" class="doc_header"><code>get_tune</code><a href="https://github.com/johnowhitaker/days_of_code/tree/master/days_of_code/abc.py#L18" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_tune</code>(<strong><code>tune_url</code></strong>, <strong><code>savefile</code></strong>=<em><code>'data/all_tunes.csv'</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="set_up_threads" class="doc_header"><code>set_up_threads</code><a href="https://github.com/johnowhitaker/days_of_code/tree/master/days_of_code/abc.py#L29" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>set_up_threads</code>(<strong><code>urls</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can use this to grab all our tunes in parallel:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">set_up_threads</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I ran this for multiple pages of search results to get 500 songs. This is what that ends up looking like:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/all_tunes.csv&#39;</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="s1">&#39;TS&#39;</span><span class="p">,</span> <span class="s1">&#39;Key&#39;</span><span class="p">,</span> <span class="s1">&#39;Notes&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>(500, 5)
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Title</th>
      <th>Type</th>
      <th>TS</th>
      <th>Key</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>The Maid Behind The Bar</th>
      <td>reel</td>
      <td>4/4</td>
      <td>1/8</td>
      <td>Dmaj</td>
      <td>|:FAAB AFED|FAAB ABde|fBBA Bcde|fBBA BcdA|FAAB...</td>
    </tr>
    <tr>
      <th>The Musical Priest</th>
      <td>reel</td>
      <td>4/4</td>
      <td>1/8</td>
      <td>Bmin</td>
      <td>|:BA|FBBA B2Bd|cBAf ecBA|FBBA B2Bd|cBAc B2:||:...</td>
    </tr>
    <tr>
      <th>Banish Misfortune</th>
      <td>jig</td>
      <td>6/8</td>
      <td>1/8</td>
      <td>Dmix</td>
      <td>fed cAG| A2d cAG| F2D DED| FEF GFG|AGA cAG| AG...</td>
    </tr>
    <tr>
      <th>The Silver Spear</th>
      <td>reel</td>
      <td>4/4</td>
      <td>1/8</td>
      <td>Dmaj</td>
      <td>A|:FA (3AAA BAFA|dfed BddA|FA (3AAA BAFA|dfed ...</td>
    </tr>
    <tr>
      <th>Drowsy Maggie</th>
      <td>reel</td>
      <td>4/4</td>
      <td>1/8</td>
      <td>Edor</td>
      <td>|:E2BE dEBE|E2BE AFDF|E2BE dEBE|BABc dAFD:|d2f...</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This dataset will be useful for a project idea I have had brewing - but my hour is up so that's where we are ending for today.</p>

</div>
</div>
</div>
</div>
 

